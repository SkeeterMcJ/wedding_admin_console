<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wedding Admin | Stanton James</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
  <style>
    :root {
      --plum: #6A567E;
      --plum-light: #8a75a0;
      --plum-dark: #4a3a5e;
      --accent: #a45ee5;
      --accent-light: #c78ff5;
      --gold: #C9A96E;
      --gold-light: #e2cc9e;
      --bg: #faf9fc;
      --card: #ffffff;
      --border: #e8e4ee;
      --text: #2d2438;
      --text-muted: #7a6e87;
      --green: #3d9a50;
      --green-bg: #edf7ef;
      --red: #c94444;
      --red-bg: #fdeaea;
      --blue: #4478cc;
      --blue-bg: #ebf0fa;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ======== LOGIN SCREEN ======== */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2C1A3D 0%, #4a3a5e 50%, #6A567E 100%);
      padding: 2rem;
    }

    .login-card {
      background: var(--card);
      border-radius: 20px;
      padding: 3rem;
      max-width: 460px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-card h1 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.8rem;
      color: var(--plum);
      margin-bottom: 0.5rem;
    }

    .login-card p {
      color: var(--text-muted);
      margin-bottom: 2rem;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.85rem 1rem;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      color: var(--text);
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .login-btn {
      width: 100%;
      padding: 1rem;
      background: var(--plum);
      color: white;
      border: none;
      border-radius: 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 0.5rem;
    }

    .login-btn:hover { background: var(--accent); }
    .login-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .login-error {
      color: var(--red);
      font-size: 0.9rem;
      margin-top: 1rem;
      display: none;
    }

    /* ======== APP LAYOUT ======== */
    .app { display: none; }
    .app.active { display: block; }
    .login-screen.hidden { display: none; }

    .topbar {
      background: var(--plum-dark);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.3rem;
      letter-spacing: 0.02em;
    }

    .topbar-title span { color: var(--gold-light); }

    .topbar-actions {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .topbar-btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.25);
      background: transparent;
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .topbar-btn:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.4);
    }

    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* ======== TAB NAV ======== */
    .tab-nav {
      display: flex;
      gap: 0;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border);
    }

    .tab-btn {
      padding: 0.85rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab-btn:hover { color: var(--plum); }

    .tab-btn.active {
      color: var(--plum);
      border-bottom-color: var(--accent);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ======== STATS GRID ======== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2.5rem;
    }

    .stat-card {
      background: var(--card);
      border-radius: 14px;
      padding: 1.5rem;
      border: 1px solid var(--border);
      transition: transform 0.15s, box-shadow 0.15s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(106, 86, 126, 0.08);
    }

    .stat-label {
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-family: 'DM Serif Display', serif;
      font-size: 2.4rem;
      color: var(--plum);
      line-height: 1;
    }

    .stat-sub {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.4rem;
    }

    .stat-card.green .stat-value { color: var(--green); }
    .stat-card.red .stat-value { color: var(--red); }
    .stat-card.gold .stat-value { color: var(--gold); }

    /* ======== CHART BARS ======== */
    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2.5rem;
    }

    .chart-card {
      background: var(--card);
      border-radius: 14px;
      padding: 1.5rem;
      border: 1px solid var(--border);
    }

    .chart-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1.15rem;
      color: var(--plum);
      margin-bottom: 1.25rem;
    }

    .bar-group {
      margin-bottom: 1rem;
    }

    .bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.35rem;
    }

    .bar-label span:last-child {
      color: var(--text-muted);
    }

    .bar-track {
      height: 28px;
      background: #f0ecf4;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
      position: relative;
    }

    .bar-fill.plum { background: var(--plum); }
    .bar-fill.green { background: var(--green); }
    .bar-fill.gold { background: var(--gold); }
    .bar-fill.accent { background: var(--accent); }
    .bar-fill.blue { background: var(--blue); }

    /* ======== GUEST TABLE ======== */
    .table-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-input {
      flex: 1;
      min-width: 220px;
      padding: 0.7rem 1rem;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      color: var(--text);
      transition: border-color 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .filter-select {
      padding: 0.7rem 1rem;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      color: var(--text);
      background: white;
      cursor: pointer;
      min-width: 160px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .export-btn {
      padding: 0.7rem 1.25rem;
      background: var(--plum);
      color: white;
      border: none;
      border-radius: 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .export-btn:hover { background: var(--accent); }

    .table-wrapper {
      background: var(--card);
      border-radius: 14px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .table-scroll {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }

    thead {
      background: #f7f4fa;
      position: sticky;
      top: 0;
    }

    th {
      padding: 0.85rem 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }

    th:hover { color: var(--plum); }
    th .sort-arrow { margin-left: 4px; opacity: 0.4; }
    th.sorted .sort-arrow { opacity: 1; color: var(--accent); }

    td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f0ecf4;
      vertical-align: top;
    }

    tr:hover td { background: #faf8fd; }

    .badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge.yes { background: var(--green-bg); color: var(--green); }
    .badge.no { background: var(--red-bg); color: var(--red); }
    .badge.pending { background: #f5f0e0; color: #9a8340; }
    .badge.meal { background: var(--blue-bg); color: var(--blue); }

    .guest-name {
      font-weight: 600;
      color: var(--plum);
    }

    .guest-email {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .notes-cell {
      max-width: 250px;
      font-size: 0.82rem;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .table-footer {
      padding: 0.85rem 1rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ======== SPECIAL RESPONSES TAB ======== */
    .responses-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .response-card {
      background: var(--card);
      border-radius: 14px;
      padding: 1.5rem;
      border: 1px solid var(--border);
    }

    .response-card h3 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.15rem;
      color: var(--plum);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .response-item {
      padding: 0.85rem 0;
      border-bottom: 1px solid #f0ecf4;
    }

    .response-item:last-child { border-bottom: none; }

    .response-item .ri-name {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--plum);
      margin-bottom: 0.25rem;
    }

    .response-item .ri-text {
      font-size: 0.9rem;
      color: var(--text);
      line-height: 1.5;
    }

    .response-empty {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
      padding: 1rem 0;
    }

    /* ======== LOADING ======== */
    .loading-overlay {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 1rem;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ======== RESPONSIVE ======== */
    @media (max-width: 900px) {
      .charts-row { grid-template-columns: 1fr; }
      .responses-grid { grid-template-columns: 1fr; }
      .main-content { padding: 1.25rem; }
    }

    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .topbar { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
      .topbar-title { font-size: 1.1rem; }
      .tab-btn { padding: 0.7rem 1rem; font-size: 0.85rem; }
      .login-card { padding: 2rem 1.5rem; }
    }
  </style>
</head>
<body>

<!-- ==================== LOGIN ==================== -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <h1>S&D Admin</h1>
    <p>Enter the admin access code to manage RSVPs and view guest responses.</p>
    <div class="form-group">
      <label>Access Code</label>
      <input type="password" id="accessCode" placeholder="Enter admin code" onkeypress="if(event.key==='Enter')handleLogin()" />
    </div>
    <button class="login-btn" id="loginBtn" onclick="handleLogin()">Sign In</button>
    <p class="login-error" id="loginError"></p>
  </div>
</div>

<!-- ==================== DASHBOARD APP ==================== -->
<div class="app" id="app">
  <div class="topbar">
    <div class="topbar-title">S<span>&</span>D Wedding Admin</div>
    <div class="topbar-actions">
      <button class="topbar-btn" onclick="refreshData()">‚Üª Refresh</button>
      <button class="topbar-btn" onclick="handleLogout()">Sign Out</button>
    </div>
  </div>

  <div class="main-content">
    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab-btn" data-tab="guests" onclick="switchTab('guests')">Guest List</button>
      <button class="tab-btn" data-tab="responses" onclick="switchTab('responses')">Song, Advice & Dietary</button>
    </div>

    <!-- ===== DASHBOARD TAB ===== -->
    <div class="tab-panel active" id="tab-dashboard">
      <div class="stats-grid" id="statsGrid">
        <div class="loading-overlay"><div class="spinner"></div> Loading stats...</div>
      </div>
      <div class="charts-row" id="chartsRow">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- ===== GUEST LIST TAB ===== -->
    <div class="tab-panel" id="tab-guests">
      <div class="table-controls">
        <input class="search-input" id="guestSearch" placeholder="Search by name, email, or code..." oninput="filterGuests()" />
        <select class="filter-select" id="rsvpFilter" onchange="filterGuests()">
          <option value="all">All Guests</option>
          <option value="responded">Has RSVP'd</option>
          <option value="pending">No RSVP Yet</option>
          <option value="ceremony-yes">Attending Ceremony</option>
          <option value="reception-yes">Attending Reception</option>
          <option value="afterparty-yes">Attending After Party</option>
        </select>
        <select class="filter-select" id="mealFilter" onchange="filterGuests()">
          <option value="all">All Meals</option>
        </select>
        <button class="export-btn" onclick="exportCSV()">‚¨á Export CSV</button>
      </div>
      <div class="table-wrapper">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th onclick="sortTable('name')">Name <span class="sort-arrow">‚Üï</span></th>
                <th onclick="sortTable('email')">Email <span class="sort-arrow">‚Üï</span></th>
                <th onclick="sortTable('code')">Code <span class="sort-arrow">‚Üï</span></th>
                <th onclick="sortTable('ceremony')">Ceremony <span class="sort-arrow">‚Üï</span></th>
                <th onclick="sortTable('reception')">Reception <span class="sort-arrow">‚Üï</span></th>
                <th onclick="sortTable('meal')">Meal <span class="sort-arrow">‚Üï</span></th>
                <th onclick="sortTable('afterparty')">After Party <span class="sort-arrow">‚Üï</span></th>
                <th>Dietary / Notes</th>
                <th onclick="sortTable('responded')">Responded <span class="sort-arrow">‚Üï</span></th>
              </tr>
            </thead>
            <tbody id="guestTableBody">
              <tr><td colspan="9"><div class="loading-overlay"><div class="spinner"></div> Loading guests...</div></td></tr>
            </tbody>
          </table>
        </div>
        <div class="table-footer">
          <span id="tableCount">0 guests</span>
          <span id="lastUpdated"></span>
        </div>
      </div>
    </div>

    <!-- ===== SPECIAL RESPONSES TAB ===== -->
    <div class="tab-panel" id="tab-responses">
      <div class="responses-grid" id="responsesGrid">
        <div class="loading-overlay"><div class="spinner"></div> Loading responses...</div>
      </div>
    </div>
  </div>
</div>

<script>
// ==========================================
// STATE
// ==========================================
let allGuests = [];       // Flat list of guests with their RSVP data joined
let filteredGuests = [];
let sortCol = 'name';
let sortDir = 'asc';

// ==========================================
// CONFIGURATION ‚Äî Set this to your edge function URL
// ==========================================
const API_URL = 'https://qykfifmhiiqrihmwfgvd.supabase.co/functions/v1/admin-api';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5a2ZpZm1oaWlxcmlobXdmZ3ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzM5MjcsImV4cCI6MjA3MzIwOTkyN30.kV72B7HpDlcI_CPGu59qrBrntANmDjhSujg_fxLiY-8';

async function apiRequest(action, params = {}) {
  const response = await fetch(API_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
    },
    body: JSON.stringify({ action, ...params })
  });
  const data = await response.json();
  if (!data.success) throw new Error(data.error || 'Request failed');
  return data;
}

// ==========================================
// LOGIN / CONNECTION
// ==========================================
async function handleLogin() {
  const code = document.getElementById('accessCode').value.trim();
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';

  if (!code) {
    errEl.textContent = 'Please enter an access code.';
    errEl.style.display = 'block';
    return;
  }

  const btn = document.getElementById('loginBtn');
  btn.disabled = true;
  btn.textContent = 'Verifying...';

  try {
    await apiRequest('login', { accessCode: code });

    // Valid ‚Äî save code for session and show dashboard
    sessionStorage.setItem('admin_code', code);
    showApp();
  } catch (e) {
    errEl.textContent = e.message === 'Invalid access code'
      ? 'Invalid access code. Please try again.'
      : 'Connection error. Please check configuration.';
    errEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Sign In';
  }
}

function handleLogout() {
  sessionStorage.removeItem('admin_code');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('app').classList.remove('active');
  document.getElementById('accessCode').value = '';
}

function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('app').classList.add('active');
  loadAllData();
}

// Auto-reconnect if already authenticated this session
(function autoConnect() {
  if (sessionStorage.getItem('admin_code')) {
    showApp();
  }
})();

// ==========================================
// DATA LOADING
// ==========================================
async function loadAllData() {
  const accessCode = sessionStorage.getItem('admin_code');
  if (!accessCode) {
    handleLogout();
    return;
  }

  try {
    const data = await apiRequest('getDashboardData', { accessCode });

    const guests = data.guests || [];
    const responses = data.responses || [];
    const mealOpts = data.mealOptions || [];

    // Build meal filter options
    const mealFilter = document.getElementById('mealFilter');
    mealFilter.innerHTML = '<option value="all">All Meals</option>';
    mealOpts.forEach(m => {
      mealFilter.innerHTML += `<option value="${m.name}">${m.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</option>`;
    });

    // Join responses onto guests
    const responseMap = {};
    responses.forEach(r => {
      if (!responseMap[r.guest_id]) responseMap[r.guest_id] = {};
      responseMap[r.guest_id][r.event_id] = r;
    });

    allGuests = guests.map(g => {
      const rsvps = responseMap[g.id] || {};
      const ceremony = rsvps[1];
      const reception = rsvps[2];
      const afterparty = rsvps[3];

      // Parse notes for song requests and advice
      let songRequest = '';
      let coupleAdvice = '';
      let dietaryRestrictions = '';

      Object.values(rsvps).forEach((r) => {
        if (r.notes) {
          const lines = r.notes.split('\n');
          lines.forEach(line => {
            if (line.startsWith('Song Request:')) {
              songRequest = line.replace('Song Request:', '').trim();
            } else if (line.startsWith('Advice:')) {
              coupleAdvice = line.replace('Advice:', '').trim();
            } else if (line.trim() && !songRequest && !coupleAdvice) {
              dietaryRestrictions = line.trim();
            }
          });
        }
      });

      if (reception?.notes && !songRequest && !coupleAdvice) {
        dietaryRestrictions = reception.notes;
      }

      const hasResponded = Object.keys(rsvps).length > 0;
      const respondedAt = ceremony?.responded_at || reception?.responded_at || afterparty?.responded_at || null;

      return {
        ...g,
        hasResponded,
        respondedAt,
        ceremony: ceremony?.attending,
        reception: reception?.attending,
        afterparty: afterparty?.attending,
        meal: reception?.meal_choice || null,
        songRequest,
        coupleAdvice,
        dietaryRestrictions,
        _raw: rsvps
      };
    });

    filteredGuests = [...allGuests];
    renderStats();
    renderCharts();
    renderGuestTable();
    renderResponses();
    document.getElementById('lastUpdated').textContent = `Updated ${new Date().toLocaleTimeString()}`;
  } catch (err) {
    console.error('Data load error:', err);
    if (err.message === 'Invalid access code') {
      handleLogout();
      const errEl = document.getElementById('loginError');
      errEl.textContent = 'Session expired. Please sign in again.';
      errEl.style.display = 'block';
    } else {
      alert('Error loading data: ' + err.message);
    }
  }
}

function refreshData() { loadAllData(); }

// ==========================================
// TABS
// ==========================================
function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === `tab-${tabId}`));
}

// ==========================================
// STATS
// ==========================================
function renderStats() {
  const total = allGuests.length;
  const responded = allGuests.filter(g => g.hasResponded).length;
  const pending = total - responded;
  const ceremonyYes = allGuests.filter(g => g.ceremony === 'yes' || g.ceremony === true).length;
  const receptionYes = allGuests.filter(g => g.reception === 'yes' || g.reception === true).length;
  const afterpartyYes = allGuests.filter(g => g.afterparty === 'yes' || g.afterparty === true).length;
  const allNo = allGuests.filter(g => g.hasResponded && g.ceremony !== 'yes' && g.ceremony !== true && g.reception !== 'yes' && g.reception !== true).length;

  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Total Invited</div>
      <div class="stat-value">${total}</div>
      <div class="stat-sub">${allGuests.filter(g => g.is_placeholder).length} plus-one slots</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">RSVPs Received</div>
      <div class="stat-value">${responded}</div>
      <div class="stat-sub">${total > 0 ? Math.round(responded/total*100) : 0}% response rate</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Awaiting Response</div>
      <div class="stat-value">${pending}</div>
      <div class="stat-sub">${total > 0 ? Math.round(pending/total*100) : 0}% still pending</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Ceremony Attending</div>
      <div class="stat-value">${ceremonyYes}</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Reception Attending</div>
      <div class="stat-value">${receptionYes}</div>
    </div>
    <div class="stat-card gold">
      <div class="stat-label">After Party</div>
      <div class="stat-value">${afterpartyYes}</div>
    </div>
    <div class="stat-card red">
      <div class="stat-label">Declined All</div>
      <div class="stat-value">${allNo}</div>
    </div>
  `;
}

// ==========================================
// CHARTS
// ==========================================
function renderCharts() {
  const responded = allGuests.filter(g => g.hasResponded);
  const total = allGuests.length || 1;

  const ceremonyYes = allGuests.filter(g => g.ceremony === 'yes' || g.ceremony === true).length;
  const ceremonyNo = allGuests.filter(g => g.ceremony === 'no' || g.ceremony === false).length;
  const receptionYes = allGuests.filter(g => g.reception === 'yes' || g.reception === true).length;
  const receptionNo = allGuests.filter(g => g.reception === 'no' || g.reception === false).length;
  const afterpartyYes = allGuests.filter(g => g.afterparty === 'yes' || g.afterparty === true).length;
  const afterpartyNo = allGuests.filter(g => g.afterparty === 'no' || g.afterparty === false).length;

  const mealCounts = {};
  responded.forEach(g => {
    if (g.meal) {
      const name = g.meal.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      mealCounts[name] = (mealCounts[name] || 0) + 1;
    }
  });

  const mealColors = ['plum', 'green', 'gold', 'accent', 'blue'];

  document.getElementById('chartsRow').innerHTML = `
    <div class="chart-card">
      <div class="chart-title">Event Attendance</div>
      ${barGroup('Ceremony', ceremonyYes, ceremonyYes + ceremonyNo, 'plum')}
      ${barGroup('Reception', receptionYes, receptionYes + receptionNo, 'green')}
      ${barGroup('After Party', afterpartyYes, afterpartyYes + afterpartyNo, 'gold')}
      ${barGroup('RSVP Progress', responded.length, total, 'accent')}
    </div>
    <div class="chart-card">
      <div class="chart-title">Meal Selections</div>
      ${Object.entries(mealCounts).length === 0
        ? '<p style="color:var(--text-muted);font-size:0.9rem;">No meal selections yet</p>'
        : Object.entries(mealCounts).map(([name, count], i) =>
            barGroup(name, count, receptionYes || 1, mealColors[i % mealColors.length])
          ).join('')
      }
    </div>
  `;
}

function barGroup(label, value, max, color) {
  const pct = max > 0 ? Math.round(value / max * 100) : 0;
  return `
    <div class="bar-group">
      <div class="bar-label"><span>${label}</span><span>${value} / ${max}</span></div>
      <div class="bar-track"><div class="bar-fill ${color}" style="width: ${pct}%"></div></div>
    </div>
  `;
}

// ==========================================
// GUEST TABLE
// ==========================================
function renderGuestTable() {
  const tbody = document.getElementById('guestTableBody');

  if (filteredGuests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:2rem;color:var(--text-muted);">No guests match your search.</td></tr>';
    document.getElementById('tableCount').textContent = '0 guests';
    return;
  }

  const sorted = [...filteredGuests].sort((a, b) => {
    let av, bv;
    switch (sortCol) {
      case 'name': av = `${a.first_name} ${a.last_name}`.toLowerCase(); bv = `${b.first_name} ${b.last_name}`.toLowerCase(); break;
      case 'email': av = (a.email || '').toLowerCase(); bv = (b.email || '').toLowerCase(); break;
      case 'code': av = a.invitation_code || ''; bv = b.invitation_code || ''; break;
      case 'ceremony': av = a.ceremony || ''; bv = b.ceremony || ''; break;
      case 'reception': av = a.reception || ''; bv = b.reception || ''; break;
      case 'afterparty': av = a.afterparty || ''; bv = b.afterparty || ''; break;
      case 'meal': av = a.meal || ''; bv = b.meal || ''; break;
      case 'responded': av = a.respondedAt || ''; bv = b.respondedAt || ''; break;
      default: av = ''; bv = '';
    }
    if (av < bv) return sortDir === 'asc' ? -1 : 1;
    if (av > bv) return sortDir === 'asc' ? 1 : -1;
    return 0;
  });

  tbody.innerHTML = sorted.map(g => {
    const name = `${g.first_name} ${g.last_name}`;
    const placeholder = g.is_placeholder ? ' <span style="font-size:0.75rem;color:var(--text-muted);">(+1 slot)</span>' : '';
    let notesDisplay = '';
    if (g.dietaryRestrictions) notesDisplay += g.dietaryRestrictions;

    return `<tr>
      <td><span class="guest-name">${name}</span>${placeholder}</td>
      <td><span class="guest-email">${g.email || '‚Äî'}</span></td>
      <td><code style="font-size:0.82rem;background:#f0ecf4;padding:0.15rem 0.4rem;border-radius:4px;">${g.invitation_code || '‚Äî'}</code></td>
      <td>${attendBadge(g.ceremony, g.hasResponded)}</td>
      <td>${attendBadge(g.reception, g.hasResponded)}</td>
      <td>${g.meal ? `<span class="badge meal">${g.meal.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</span>` : '<span style="color:var(--text-muted);">‚Äî</span>'}</td>
      <td>${attendBadge(g.afterparty, g.hasResponded)}</td>
      <td class="notes-cell">${notesDisplay || '<span style="color:var(--text-muted);">‚Äî</span>'}</td>
      <td style="white-space:nowrap;">${g.respondedAt ? new Date(g.respondedAt).toLocaleDateString() : '<span class="badge pending">Pending</span>'}</td>
    </tr>`;
  }).join('');

  document.getElementById('tableCount').textContent = `${filteredGuests.length} of ${allGuests.length} guests`;
}

function attendBadge(value, hasResponded) {
  if (value === 'yes' || value === true) return '<span class="badge yes">Yes</span>';
  if (value === 'no' || value === false) return '<span class="badge no">No</span>';
  return hasResponded ? '<span class="badge no">No</span>' : '<span style="color:var(--text-muted);">‚Äî</span>';
}

function sortTable(col) {
  if (sortCol === col) {
    sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  } else {
    sortCol = col;
    sortDir = 'asc';
  }
  document.querySelectorAll('th').forEach(th => th.classList.remove('sorted'));
  renderGuestTable();
}

function filterGuests() {
  const search = document.getElementById('guestSearch').value.toLowerCase().trim();
  const rsvpFilter = document.getElementById('rsvpFilter').value;
  const mealFilter = document.getElementById('mealFilter').value;

  filteredGuests = allGuests.filter(g => {
    if (search) {
      const haystack = `${g.first_name} ${g.last_name} ${g.email || ''} ${g.invitation_code || ''}`.toLowerCase();
      if (!haystack.includes(search)) return false;
    }

    switch (rsvpFilter) {
      case 'responded': if (!g.hasResponded) return false; break;
      case 'pending': if (g.hasResponded) return false; break;
      case 'ceremony-yes': if (g.ceremony !== 'yes' && g.ceremony !== true) return false; break;
      case 'reception-yes': if (g.reception !== 'yes' && g.reception !== true) return false; break;
      case 'afterparty-yes': if (g.afterparty !== 'yes' && g.afterparty !== true) return false; break;
    }

    if (mealFilter !== 'all' && g.meal !== mealFilter) return false;

    return true;
  });

  renderGuestTable();
}

// ==========================================
// RESPONSES TAB
// ==========================================
function renderResponses() {
  const songRequests = allGuests.filter(g => g.songRequest).map(g => ({
    name: `${g.first_name} ${g.last_name}`,
    text: g.songRequest
  }));

  const advice = allGuests.filter(g => g.coupleAdvice).map(g => ({
    name: `${g.first_name} ${g.last_name}`,
    text: g.coupleAdvice
  }));

  const dietary = allGuests.filter(g => g.dietaryRestrictions).map(g => ({
    name: `${g.first_name} ${g.last_name}`,
    text: g.dietaryRestrictions
  }));

  const otherNotes = [];
  allGuests.forEach(g => {
    Object.values(g._raw).forEach(r => {
      if (r.notes) {
        const cleaned = r.notes
          .split('\n')
          .filter(l => !l.startsWith('Song Request:') && !l.startsWith('Advice:') && l.trim())
          .join(', ')
          .trim();
        if (cleaned && cleaned !== g.dietaryRestrictions) {
          otherNotes.push({ name: `${g.first_name} ${g.last_name}`, text: cleaned });
        }
      }
    });
  });

  document.getElementById('responsesGrid').innerHTML = `
    <div class="response-card">
      <h3>üéµ Song Requests <span style="font-size:0.85rem;color:var(--text-muted);font-family:'DM Sans',sans-serif;">(${songRequests.length})</span></h3>
      ${songRequests.length === 0
        ? '<p class="response-empty">No song requests yet</p>'
        : songRequests.map(r => `<div class="response-item"><div class="ri-name">${r.name}</div><div class="ri-text">${r.text}</div></div>`).join('')
      }
    </div>
    <div class="response-card">
      <h3>üíï Couple Advice <span style="font-size:0.85rem;color:var(--text-muted);font-family:'DM Sans',sans-serif;">(${advice.length})</span></h3>
      ${advice.length === 0
        ? '<p class="response-empty">No advice submitted yet</p>'
        : advice.map(r => `<div class="response-item"><div class="ri-name">${r.name}</div><div class="ri-text">${r.text}</div></div>`).join('')
      }
    </div>
    <div class="response-card">
      <h3>üçΩ Dietary Restrictions <span style="font-size:0.85rem;color:var(--text-muted);font-family:'DM Sans',sans-serif;">(${dietary.length})</span></h3>
      ${dietary.length === 0
        ? '<p class="response-empty">No dietary restrictions noted</p>'
        : dietary.map(r => `<div class="response-item"><div class="ri-name">${r.name}</div><div class="ri-text">${r.text}</div></div>`).join('')
      }
    </div>
    <div class="response-card">
      <h3>üìù Other Notes <span style="font-size:0.85rem;color:var(--text-muted);font-family:'DM Sans',sans-serif;">(${otherNotes.length})</span></h3>
      ${otherNotes.length === 0
        ? '<p class="response-empty">No additional notes</p>'
        : otherNotes.map(r => `<div class="response-item"><div class="ri-name">${r.name}</div><div class="ri-text">${r.text}</div></div>`).join('')
      }
    </div>
  `;
}

// ==========================================
// CSV EXPORT
// ==========================================
function exportCSV() {
  const headers = ['First Name','Last Name','Email','Invitation Code','Ceremony','Reception','Meal Choice','After Party','Dietary Restrictions','Song Request','Couple Advice','Responded At'];

  const rows = filteredGuests.map(g => [
    g.first_name,
    g.last_name,
    g.email || '',
    g.invitation_code || '',
    g.ceremony === 'yes' || g.ceremony === true ? 'Yes' : g.ceremony === 'no' || g.ceremony === false ? 'No' : 'Pending',
    g.reception === 'yes' || g.reception === true ? 'Yes' : g.reception === 'no' || g.reception === false ? 'No' : 'Pending',
    g.meal ? g.meal.replace(/_/g,' ') : '',
    g.afterparty === 'yes' || g.afterparty === true ? 'Yes' : g.afterparty === 'no' || g.afterparty === false ? 'No' : 'Pending',
    g.dietaryRestrictions || '',
    g.songRequest || '',
    g.coupleAdvice || '',
    g.respondedAt ? new Date(g.respondedAt).toLocaleString() : ''
  ]);

  const csv = [headers, ...rows]
    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    .join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `wedding-rsvps-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>